name: Claude PR Review

# Automated PR review using Claude Code Action
# Triggers on new PRs and updates to source/test files

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - 'source/**'
      - 'tests/**'
      - 'prelude/**'
      - 'include/**'

permissions:
  contents: read
  pull-requests: write
  issues: write
  actions: read

jobs:
  review:
    name: Automated Code Review
    # Skip draft PRs and bot-generated PRs
    if: |
      github.event.pull_request.draft == false &&
      !contains(github.event.pull_request.user.login, '[bot]')
    # TODO: Change back to [Windows, self-hosted, GCP-T4] once fork runner permissions are configured
    runs-on: ubuntu-latest
    timeout-minutes: 30

    # Cancel previous runs for the same PR
    concurrency:
      group: claude-review-${{ github.event.pull_request.number }}
      cancel-in-progress: true

    steps:
      # Windows-specific setup: Add bash to PATH
      - name: Add bash to PATH (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Add-Content -Path $env:GITHUB_PATH -Value "C:\Program Files\Git\bin"
          Add-Content -Path $env:GITHUB_PATH -Value "C:\Program Files\Git\usr\bin"

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false

      - name: Run Claude Code Review
        uses: ./.github/actions/claude-code-runner
        with:
          # Authentication provider selection (set via repository variable)
          auth-provider: ${{ vars.CLAUDE_AUTH_PROVIDER || 'llmgw' }}

          # LLM Gateway authentication (used when auth-provider=llmgw)
          llmgw-id: ${{ secrets.LLMGW_ID }}
          llmgw-secret: ${{ secrets.LLMGW_SECRET }}
          llmgw-token-url: ${{ secrets.LLMGW_TOKEN_URL }}

          # NVIDIA Inference Portal authentication (used when auth-provider=nv-inference)
          nv-inference-url: ${{ vars.NV_INFERENCE_URL || 'https://inference-api.nvidia.com' }}
          nv-inference-token: ${{ secrets.NV_INFERENCE_TOKEN }}
          nv-inference-opus-model: ${{ vars.NV_INFERENCE_OPUS_MODEL || 'aws/anthropic/claude-opus-4-5' }}
          nv-inference-sonnet-model: ${{ vars.NV_INFERENCE_SONNET_MODEL || 'aws/anthropic/bedrock-claude-sonnet-4-5-v1' }}
          nv-inference-haiku-model: ${{ vars.NV_INFERENCE_HAIKU_MODEL || 'aws/anthropic/claude-haiku-4-5-v1' }}

          github-token-fallback: ${{ secrets.GITHUB_TOKEN }}

          # AUTOMATION MODE - Systematic PR Analysis
          # Follow the /pr-review-analysis command in .claude/commands/
          prompt: |
            Perform a **systematic PR analysis**. Use the `/pr-review-analysis` command as your guide.

            **IMPORTANT:** You MUST:
            1. Execute actual tool calls (read files, search, run git commands)
            2. Log every action you take
            3. Output findings in the structured format with file:line references
            4. Categorize issues as Bugs/Flags/Suggestions

            Start by reading the PR diff and changed files, then investigate systematically.

          # Custom instructions for systematic review
          custom-instructions: |
            You are a **PR Analysis Agent**. Follow the methodology in `/pr-review-analysis`.

            ## Process Overview
            1. **Gather Context**: Read docs (CLAUDE.md, CONTRIBUTING.md), fetch PR, check history
            2. **Investigate**: Search patterns, cross-reference, validate references
            3. **Detect Issues**: Categorize as ðŸ”´ Bugs / ðŸŸ¡ Flags / ðŸ”µ Suggestions
            4. **Report**: Structured output with file:line refs, code snippets, investigation log

            ## Output Requirements
            - Every finding MUST have `file:line` reference
            - Show problematic code AND suggested fix
            - Log all investigation steps taken
            - End with summary table and recommendation

            Use available tools (read, search, git, gh) to investigate thoroughly.

          # MCP configuration for deepwiki
          mcp-config: |
            {
              "mcpServers": {
                "deepwiki": {
                  "type": "sse",
                  "url": "https://mcp.deepwiki.com/sse"
                }
              }
            }

          # Tools for PR review with inline comments
          # Note: Bash tool patterns use space separators, not colons
          # GitHub MCP tools for pending review workflow (create -> add comments -> submit)
          allowed-tools: |
            View,GlobTool,GrepTool,
            Bash(gh pr diff *),
            Bash(gh pr view *),
            Bash(gh pr comment *),
            Bash(git log *),
            Bash(git diff *),
            Bash(git show *),
            mcp__github__create_pending_pull_request_review,
            mcp__github__add_pull_request_review_comment_to_pending_review,
            mcp__github__submit_pending_pull_request_review,
            mcp__github__get_pull_request_diff,
            mcp__deepwiki__ask_question

          # Progress tracking
          track-progress: 'true'
          include-fix-links: 'true'

          # Model configuration
          model: ${{ vars.ANTHROPIC_MODEL || 'claude-sonnet-4-20250514' }}
          max-turns: '100'

          # Bedrock configuration
          aws-region: ${{ vars.AWS_REGION }}
          bedrock-base-url: ${{ vars.ANTHROPIC_BEDROCK_BASE_URL }}
