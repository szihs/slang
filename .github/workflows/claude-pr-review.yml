name: Claude PR Review

# Automated PR review - simplified pattern matching reference example
# See: claude-code-action/examples/pr-review-comprehensive.yml

on:
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened]
    paths:
      - 'source/**'
      - 'tests/**'
      - 'prelude/**'
      - 'include/**'

permissions:
  contents: read
  pull-requests: write
  actions: read  # Required for Claude to read CI check results on PRs
  id-token: write

jobs:
  review:
    # Skip draft PRs, bot PRs, and Claude's own branches (loop prevention)
    if: |
      github.event.pull_request.draft == false &&
      !contains(github.event.pull_request.user.login, '[bot]') &&
      !startsWith(github.event.pull_request.head.ref, 'claude/')
    runs-on: ubuntu-latest
    timeout-minutes: 30

    # Centralized auth configuration
    env:
      CLAUDE_AUTH_PROVIDER: ${{ vars.CLAUDE_AUTH_PROVIDER || 'llmgw' }}
      LLMGW_ID: ${{ secrets.LLMGW_ID }}
      LLMGW_SECRET: ${{ secrets.LLMGW_SECRET }}
      LLMGW_TOKEN_URL: ${{ secrets.LLMGW_TOKEN_URL }}
      NV_INFERENCE_TOKEN: ${{ secrets.NV_INFERENCE_TOKEN }}

    concurrency:
      group: claude-review-${{ github.event.pull_request.number }}
      cancel-in-progress: true

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: PR Review with Progress Tracking
        uses: ./.github/actions/claude-code-runner
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            Perform a comprehensive code review focusing on:
            1. Code quality and best practices
            2. Potential bugs or security issues
            3. Performance considerations
            4. Test coverage

            Provide detailed feedback using inline comments for specific issues.
            Use top-level comments for general observations.

          # Tools for PR review with inline comments
          allowed-tools: |
            View,GlobTool,GrepTool,
            Bash(gh pr diff *),
            Bash(gh pr view *),
            Bash(gh pr comment *),
            mcp__github_inline_comment__create_inline_comment,
            mcp__github__get_pull_request_diff
